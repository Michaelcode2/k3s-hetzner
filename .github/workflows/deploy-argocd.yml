name: Deploy ArgoCD

on:
  workflow_dispatch:

jobs:
  deploy-argocd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Kubeconfig Secret
        run: |
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "‚ùå ERROR: KUBECONFIG secret is not set!"
            echo ""
            echo "To use this standalone workflow, you need to:"
            echo "1. Get your kubeconfig file from the provisioning workflow artifact"
            echo "2. Add it as a GitHub Secret named 'KUBECONFIG'"
            echo ""
            echo "Alternatively, use the combined provisioning workflow which"
            echo "automatically deploys ArgoCD after cluster creation."
            exit 1
          fi

      - name: Set Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Verify Cluster Connection
        run: |
          echo "Testing cluster connection..."
          kubectl cluster-info
          kubectl get nodes

      - name: Create ArgoCD Namespace
        run: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

      - name: Install ArgoCD
        run: |
          echo "Installing ArgoCD using server-side apply to handle large CRDs..."
          kubectl apply --server-side -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

      - name: Wait for ArgoCD Server
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

      - name: Configure ArgoCD for Ingress
        run: |
          echo "Configuring ArgoCD server to run in insecure mode behind ingress..."
          kubectl patch deployment argocd-server -n argocd --type='json' \
            -p='[{"op": "add", "path": "/spec/template/spec/containers/0/command/-", "value": "--insecure"}]'
          
          echo "Waiting for ArgoCD server to restart..."
          kubectl rollout status deployment/argocd-server -n argocd --timeout=300s

      - name: Configure Ingress
        run: kubectl apply --server-side -f config/argocd-ingress.yaml

      - name: Verify ArgoCD Installation
        run: |
          echo "Waiting for ArgoCD components to be ready..."
          sleep 10
          kubectl get pods -n argocd
          kubectl get svc -n argocd
          kubectl get ingress -n argocd

      - name: Post-Install Instructions
        run: |
          echo "========================================="
          echo "‚úÖ ArgoCD installed successfully!"
          echo "========================================="
          echo ""
          echo "üìã Access Credentials:"
          echo "   Username: admin"
          echo ""
          echo "üîê To retrieve the admin password, run:"
          echo "   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d; echo"
          echo ""
          echo "üåê Access ArgoCD UI via Ingress:"
          echo "   https://<CLUSTER_IP>/"
          echo ""
          echo "üí° Alternative - Port Forward (local access):"
          echo "   kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "   Then access: https://localhost:8080"
          echo ""
          echo "‚ö†Ô∏è  Note: You may see a certificate warning with self-signed certs."
          echo "========================================="
